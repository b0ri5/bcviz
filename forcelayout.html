<!DOCTYPE html>
<meta charset="utf-8">
<style>

.node {
  stroke-width: 1.5px;
}

</style>
<body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.4.11/d3.min.js"></script>
<script src="https://code.jquery.com/jquery-latest.min.js"></script>
<script src="https://jquery-csv.googlecode.com/git/src/jquery.csv.js"></script>
<script>

// Taken from https://drive.google.com/#folders/0B64XK3VaP-HNUW9NSkV5bURGVmc
var bcvizFolderId = '0B64XK3VaP-HNUW9NSkV5bURGVmc';
var xhr = new XMLHttpRequest();
xhr.open('GET', 'https://googledrive.com/host/' + bcvizFolderId + '/' + 'milestones-only.csv');
xhr.onload = function() {
  var csvs = $.csv.toObjects(xhr.responseText);
  console.log('Parsed ' + csvs.length + ' csv entries');
  setupLayout(csvs);
};
xhr.send();

function setupLayout(csvs) {
  var birthDate = new Date("2013-08-29");
  var birthdayDate = new Date("2014-08-29");
  var lifeMillis = birthdayDate - birthDate;
  
  var width = 960,
      height = 1000;
  
  var fill = d3.scale.category10();
  
  var nodeYs = csvs.map(function(csv) {
    var milestoneMillis = new Date(csv['Date and Time']) - birthDate;
    return height * (milestoneMillis / lifeMillis) + 15;
  });
  
  var nodes = csvs.map(function(csv, i) {
    return {
      index: i,
      x: width / 2,
      y: nodeYs[i]
    };
  });
  console.log(nodes);

  var force = d3.layout.force()
      .nodes(nodes)
      .size([width, height])
      .on("tick", tick)
      .charge(-50)
      .theta(0.8)
      .start();
  
  var svg = d3.select("body").append("svg")
      .attr("width", width)
      .attr("height", height);
  
  var gs = svg.selectAll(".node")
      .data(nodes)
    .enter().append("g")
      .attr("class", "node")
      .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")";});
  gs.append("circle")
      .attr("r", 14)
      .style("fill", function(d, i) { return fill(i & 3); })
      .style("stroke", function(d, i) { return d3.rgb(fill(i & 3)).darker(2); })
      .call(force.drag)
      .on("mousedown", function() { d3.event.stopPropagation(); });
  var texts = gs.append("text")
      .attr("text-anchor", "middle")
      .text(function(d) { return d.index + 1; })
      .attr("dy", "5.5px")
      .attr("style", "pointer-events: none;");

  svg.style("opacity", 1e-6)
    .transition()
      .duration(1000)
      .style("opacity", 1);
  
  d3.select("body")
      .on("mousedown", mousedown);
  
  var ticks = 0;
  var ys = [];
  
  function tick(e) {
    nodes.forEach(function(o, i) {
      o.y = nodeYs[i];
    });
    gs.attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")";});
  }
  
  function mousedown() {
    nodes.forEach(function(o, i) {
      o.x += (Math.random() - .5) * 40;
      o.y += (Math.random() - .5) * 40;
    });
    force.resume();
  }
  
  function drawAxis() {
    var x = d3.time.scale()
        .domain([birthDate, birthdayDate])
        .range([0, 200]);
    var xAxis = d3.svg.axis()
        .scale(x);
    svg.append("g")
        .attr("class", "x axis")
        .attr("transform", "translate(0," + height + ")")
        .call(xAxis);
  }
  
  drawAxis();
}
</script>

